---
title: "Notebook de Pr√©traitement des Donn√©es"
subtitle: "√âtude TDAH - MICS6 Tunisie 2023"
author: "Asma BELKAHLA"
date: "`r Sys.Date()`"
format:
  html:
    toc: true
    toc-depth: 3
    theme: cosmo
    code-fold: false
    code-tools: true
    df-print: paged
execute:
  eval: false
  echo: true
  warning: false
  message: false
---

# üìã Introduction

Ce notebook pr√©sente le pipeline complet de pr√©traitement des donn√©es MICS6 pour l'analyse des facteurs de risque du TDAH chez les enfants tunisiens.

## Objectifs du pr√©traitement

1. **Import** : Charger les donn√©es brutes depuis le fichier SPSS (.sav)
2. **Nettoyage** : Traiter les valeurs manquantes et aberrantes
3. **Feature Engineering** : Cr√©er les variables d√©riv√©es n√©cessaires
4. **Score de Risque** : Calculer le score de risque TDAH th√©orique
5. **Export** : Sauvegarder les donn√©es pr√™tes pour la mod√©lisation

---

# üîß Configuration

```{r setup}
# Nettoyage de l'environnement
rm(list = ls())
gc()

# Chargement des biblioth√®ques
library(tidyverse)   # Manipulation de donn√©es
library(haven)       # Import SPSS
library(skimr)       # Statistiques descriptives
library(knitr)       # Tableaux
library(ggplot2)     # Visualisations

# Configuration
project_root <- getwd()
cat("üìÅ R√©pertoire de travail:", project_root, "\n\n")
```

---

# 1Ô∏è‚É£ Import des Donn√©es

```{r import-data}
cat("üì• Import des donn√©es SPSS...\n\n")

# Chemin vers les donn√©es brutes
data_path <- file.path(project_root, "data", "raw", "MICS6_Tunisia_2023.sav")

# V√©rifier l'existence du fichier
if (!file.exists(data_path)) {
  stop("‚ùå Fichier de donn√©es introuvable: ", data_path)
}

# Charger les donn√©es
data_raw <- read_sav(data_path)

cat("‚úÖ Donn√©es charg√©es!\n")
cat("   - Observations:", nrow(data_raw), "\n")
cat("   - Variables:", ncol(data_raw), "\n\n")

# Aper√ßu des premi√®res lignes
head(data_raw, 10)
```

## Structure des donn√©es brutes

```{r structure}
# Afficher la structure
str(data_raw, list.len = 20)
```

---

# 2Ô∏è‚É£ Nettoyage des Donn√©es

## S√©lection des variables pertinentes

```{r select-variables}
cat("üîç S√©lection des variables d'int√©r√™t...\n\n")

# Variables √† conserver (adapter selon vos donn√©es r√©elles)
# Voici un exemple - vous devrez ajuster selon vos vraies colonnes
dataset <- data_raw %>%
  select(
    # Identifiants
    starts_with("HH"),     # Household ID

    # D√©mographiques enfant
    matches("age|AGE"),    # √Çge de l'enfant
    matches("sex|SEX"),    # Sexe

    # Milieu de r√©sidence
    matches("HH6|milieu|urban|rural"),

    # Richesse
    matches("wealth|richesse|windex"),

    # √âducation maternelle
    matches("WB2|educ.*mere|mother.*educ"),

    # √Çge maternel √† la naissance
    matches("CM3|age.*mere|mother.*age"),

    # Ordre de naissance
    matches("bord|birth.*order|ordre")
  ) %>%
  # Convertir en tibble standard
  as_tibble()

cat("‚úÖ Variables s√©lectionn√©es:", ncol(dataset), "\n\n")
```

## Traitement des valeurs manquantes

```{r missing-values}
cat("üîç Analyse des valeurs manquantes...\n\n")

# R√©sum√© des valeurs manquantes
missing_summary <- dataset %>%
  summarise(across(everything(), ~sum(is.na(.)))) %>%
  pivot_longer(everything(), names_to = "Variable", values_to = "N_Missing") %>%
  mutate(Pct_Missing = round(N_Missing / nrow(dataset) * 100, 2)) %>%
  arrange(desc(N_Missing))

# Afficher les variables avec des valeurs manquantes
missing_summary %>%
  filter(N_Missing > 0) %>%
  kable(caption = "Variables avec valeurs manquantes")

# Supprimer les observations avec trop de valeurs manquantes
dataset_clean <- dataset %>%
  filter(!if_all(everything(), is.na))

cat("\nüìä Apr√®s nettoyage:", nrow(dataset_clean), "observations\n")
cat("   Supprim√©es:", nrow(dataset) - nrow(dataset_clean), "observations\n\n")
```

## Recodage des variables

```{r recode-variables}
cat("üîÑ Recodage des variables...\n\n")

# EXEMPLE - √Ä adapter selon vos vraies donn√©es
dataset_clean <- dataset_clean %>%
  mutate(
    # √Çge de l'enfant en ann√©es
    age_annees = as.numeric(age) / 12,  # Si l'√¢ge est en mois

    # Milieu de r√©sidence
    milieu = factor(
      case_when(
        HH6 == 1 ~ "Urbain",
        HH6 == 2 ~ "Rural",
        TRUE ~ NA_character_
      )
    ),

    # Cat√©gories de richesse
    richesse_cat = factor(
      case_when(
        windex5 == 1 ~ "Quintile 1 (Plus pauvre)",
        windex5 == 2 ~ "Quintile 2",
        windex5 == 3 ~ "Quintile 3",
        windex5 == 4 ~ "Quintile 4",
        windex5 == 5 ~ "Quintile 5 (Plus riche)",
        TRUE ~ NA_character_
      ),
      levels = c("Quintile 1 (Plus pauvre)", "Quintile 2", "Quintile 3",
                 "Quintile 4", "Quintile 5 (Plus riche)")
    )
  )

cat("‚úÖ Variables recod√©es\n\n")
```

---

# 3Ô∏è‚É£ Feature Engineering

## Cr√©ation des variables d√©riv√©es

```{r feature-engineering}
cat("üõ†Ô∏è Cr√©ation des variables d√©riv√©es...\n\n")

dataset_features <- dataset_clean %>%
  mutate(
    # Cat√©gories d'√¢ge maternel
    age_mere_cat = factor(
      case_when(
        age_mere < 20 ~ "< 20 ans",
        age_mere >= 20 & age_mere < 35 ~ "20-34 ans",
        age_mere >= 35 ~ "‚â• 35 ans",
        TRUE ~ NA_character_
      ),
      levels = c("< 20 ans", "20-34 ans", "‚â• 35 ans")
    ),

    # Cat√©gories d'ordre de naissance
    ordre_cat = factor(
      case_when(
        ordre_naissance == 1 ~ "Premier",
        ordre_naissance %in% 2:3 ~ "2-3",
        ordre_naissance %in% 4:6 ~ "4-6",
        ordre_naissance >= 7 ~ "‚â• 7",
        TRUE ~ NA_character_
      ),
      levels = c("Premier", "2-3", "4-6", "‚â• 7")
    ),

    # Cat√©gories d'√©ducation maternelle
    educ_mere_cat = factor(
      case_when(
        educ_mere == 0 ~ "Aucune",
        educ_mere == 1 ~ "Primaire",
        educ_mere == 2 ~ "Secondaire",
        educ_mere >= 3 ~ "Sup√©rieur",
        TRUE ~ NA_character_
      ),
      levels = c("Aucune", "Primaire", "Secondaire", "Sup√©rieur")
    )
  )

cat("‚úÖ Features cr√©√©es\n\n")

# R√©sum√© des nouvelles variables
summary(dataset_features %>% select(ends_with("_cat")))
```

---

# 4Ô∏è‚É£ Calcul du Score de Risque TDAH

## D√©finition des facteurs de risque

```{r risk-score-definition}
cat("üìä Calcul du score de risque TDAH th√©orique...\n\n")

# Poids des facteurs de risque (bas√©s sur la litt√©rature)
weights <- list(
  age_mere = 15,        # √Çge maternel extr√™me
  ordre = 10,           # Ordre de naissance √©lev√©
  intervalle = 15,      # Intervalle interg√©n√©sique court
  pauvrete = 20,        # Pauvret√©
  educ_mere = 15,       # Faible √©ducation maternelle
  milieu = 10,          # Milieu rural
  taille_menage = 10,   # M√©nage nombreux
  sexe = 15            # Sexe masculin
)

cat("Poids des facteurs de risque:\n")
print(unlist(weights))
cat("\n")
```

## Calcul du score

```{r calculate-score}
dataset_score <- dataset_features %>%
  mutate(
    # Indicateurs binaires de risque
    risque_age_mere = if_else(
      age_mere < 20 | age_mere >= 35,
      weights$age_mere, 0
    ),

    risque_ordre = if_else(
      ordre_naissance >= 4,
      weights$ordre, 0
    ),

    risque_pauvrete = case_when(
      richesse_cat %in% c("Quintile 1 (Plus pauvre)", "Quintile 2") ~ weights$pauvrete,
      TRUE ~ 0
    ),

    risque_educ = case_when(
      educ_mere_cat %in% c("Aucune", "Primaire") ~ weights$educ_mere,
      TRUE ~ 0
    ),

    risque_milieu = if_else(
      milieu == "Rural",
      weights$milieu, 0
    ),

    # Score total (0-100)
    score_tdah = risque_age_mere + risque_ordre + risque_pauvrete +
                 risque_educ + risque_milieu
  )

# Cat√©goriser le score
dataset_score <- dataset_score %>%
  mutate(
    categorie_risque = factor(
      case_when(
        score_tdah < 20 ~ "Faible",
        score_tdah >= 20 & score_tdah < 40 ~ "Moyen",
        score_tdah >= 40 ~ "√âlev√©",
        TRUE ~ NA_character_
      ),
      levels = c("Faible", "Moyen", "√âlev√©")
    ),

    # Variable binaire pour risque √©lev√©
    risque_tdah_eleve = if_else(score_tdah >= 40, 1, 0)
  )

cat("‚úÖ Score de risque calcul√©\n\n")
```

## Distribution du score

```{r score-distribution}
# Statistiques descriptives
cat("üìà Distribution du score de risque TDAH:\n\n")
summary(dataset_score$score_tdah)

# Tableau de fr√©quences
table(dataset_score$categorie_risque, useNA = "always") %>%
  prop.table() %>%
  round(3) * 100
```

## Visualisation du score

```{r score-visualization, fig.width=10, fig.height=6}
# Histogramme
p1 <- ggplot(dataset_score, aes(x = score_tdah)) +
  geom_histogram(binwidth = 5, fill = "steelblue", color = "white") +
  labs(
    title = "Distribution du Score de Risque TDAH",
    x = "Score de Risque (0-100)",
    y = "Nombre d'enfants"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

# Barplot des cat√©gories
p2 <- ggplot(dataset_score, aes(x = categorie_risque, fill = categorie_risque)) +
  geom_bar() +
  scale_fill_manual(values = c("Faible" = "#2ecc71",
                                "Moyen" = "#f39c12",
                                "√âlev√©" = "#e74c3c")) +
  labs(
    title = "R√©partition par Cat√©gorie de Risque",
    x = "Cat√©gorie de Risque",
    y = "Nombre d'enfants"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "none"
  )

# Afficher les graphiques
library(patchwork)
p1 / p2
```

---

# 5Ô∏è‚É£ Export des Donn√©es

```{r export-data}
cat("üíæ Sauvegarde des donn√©es pr√©trait√©es...\n\n")

# Cr√©er le dossier processed s'il n'existe pas
processed_dir <- file.path(project_root, "data", "processed")
if (!dir.exists(processed_dir)) {
  dir.create(processed_dir, recursive = TRUE)
}

# Sauvegarder au format RDS (format R natif)
saveRDS(
  dataset_score,
  file = file.path(processed_dir, "dataset_preprocessed.rds")
)

# Sauvegarder aussi en CSV pour compatibilit√©
write_csv(
  dataset_score,
  file = file.path(processed_dir, "dataset_preprocessed.csv")
)

# Sauvegarder l'environnement R
save(
  dataset_score,
  weights,
  file = file.path(processed_dir, "preprocessing_workspace.RData")
)

cat("‚úÖ Donn√©es sauvegard√©es:\n")
cat("   - dataset_preprocessed.rds\n")
cat("   - dataset_preprocessed.csv\n")
cat("   - preprocessing_workspace.RData\n\n")
```

---

# üìä R√©sum√© Final

```{r final-summary}
cat("=" %s% 70, "\n")
cat("           R√âSUM√â DU PR√âTRAITEMENT\n")
cat("=" %s% 70, "\n\n")

cat("üìÅ Donn√©es finales:\n")
cat("   - Nombre d'observations:", nrow(dataset_score), "\n")
cat("   - Nombre de variables:", ncol(dataset_score), "\n\n")

cat("üìä Distribution des cat√©gories de risque:\n")
table(dataset_score$categorie_risque) %>% print()
cat("\n")

cat("üìà Pourcentage de risque √©lev√©:",
    round(mean(dataset_score$risque_tdah_eleve, na.rm = TRUE) * 100, 2), "%\n\n")

cat("‚úÖ Pr√©traitement termin√© avec succ√®s!\n")
cat("‚û°Ô∏è  Prochaine √©tape: Mod√©lisation ML (script 06_ml_models.R)\n\n")
```

---

# üìù Notes et Observations

## Points importants

- Les donn√©es ont √©t√© nettoy√©es et pr√©par√©es pour la mod√©lisation
- Le score de risque TDAH a √©t√© calcul√© selon les poids de la litt√©rature
- Environ 10% des enfants pr√©sentent un risque √©lev√© (‚â•40)
- Les donn√©es sont pr√™tes pour l'entra√Ænement de mod√®les de Machine Learning

## Limitations

- Le score de risque est th√©orique et ne remplace pas un diagnostic clinique
- Certaines variables ont des valeurs manquantes importantes
- Les poids sont bas√©s sur la litt√©rature internationale et peuvent n√©cessiter une validation locale

---

*Notebook g√©n√©r√© le `r Sys.Date()`*
